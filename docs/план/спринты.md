Ок, даю жёсткое ТЗ под «микросервисный» учебный проект. Цель — прокачать **REST**, **асинхронный Python**, **Docker Compose**, **Nginx**, **Alembic**, **Pydantic v2**, **наблюдаемость**, **CI/CD** и базовые интеграции между сервисами.

---

# ТЗ: «TaskHub» — микросервисный менеджер задач

## 0) Результат

Готовый репозиторий, который поднимается одной командой и даёт:

* REST-API аутентификации (JWT), REST-API задач (CRUD, статусы, дедлайны, теги), REST-API уведомлений (эмуляция e-mail/Webhook).
* API-шлюз через Nginx (единая точка входа `http://localhost`).
* Наблюдаемость: метрики (Prometheus), дашборд (Grafana), логи (Loki/Promtail), трассировки (OTel Collector).
* Фоновая обработка (Celery + Redis): напоминания перед дедлайнами, отложенные уведомления.
* Стабильные миграции (Alembic), чёткие модели (SQLAlchemy 2.0), валидация (Pydantic v2).
* Тесты (pytest), линтеры (ruff, mypy), базовый CI (GitHub Actions).

---

## 1) Архитектура (микросервисы)

```
                           ┌─────────────┐
                HTTP/JSON  │   NGINX     │  :80
           ───────────────▶│ API Gateway │────────────────────────────┐
                           └──────┬──────┘                            │
                                  │/auth/* → auth-svc                 │
                                  │/tasks/* → task-svc                 │
                                  │/notify/* → notify-svc              │
                                  │/metrics  → Prometheus scrape       │
                                  │/docs per svc via /<svc>/docs       │
        ┌──────────────────────┐  ┌───────────────────────┐   ┌───────────────────────┐
        │      auth-svc        │  │       task-svc        │   │      notify-svc       │
        │ FastAPI, SQLA, JWT   │  │ FastAPI, SQLA         │   │ FastAPI + Celery      │
        │ PostgreSQL (auth-db) │  │ PostgreSQL (task-db)  │   │ Redis broker, PG opt. │
        └─────────┬────────────┘  └──────────┬────────────┘   └──────────┬────────────┘
                  │ JWT                       │ Event/Webhook             │ Celery worker
                  │                           │ (HTTP)                    │
                  ▼                           ▼                           ▼
              Key endpoints               Task CRUD, tags,           send_email (mock),
              /auth/register              deadlines, assignees       send_webhook, reminders
              /auth/login
              /auth/refresh
        
        Infra: Postgres x2, Redis, Prometheus, Grafana, Loki+Promtail, OTel Collector
```

---

## 2) Технологический стек (версии зафиксировать)

* **Python 3.12**
* **FastAPI 0.115+**, **Uvicorn 0.30+**, **Gunicorn 22+**
* **Pydantic v2**, **SQLAlchemy 2.0+ (async)**, **asyncpg**
* **Alembic 1.13+**
* **Celery 5.4+**, **Redis 7.x**
* **PostgreSQL 16.x** (отдельно для `auth-svc` и `task-svc`)
* **Nginx 1.25+**
* **Prometheus 2.x**, **Grafana 10.x**, **Loki 2.x**, **Promtail 2.x**
* **OpenTelemetry**: `opentelemetry-sdk`, `opentelemetry-instrumentation-fastapi`, OTLP exporter, **otel-collector**
* **pytest**, **httpx** (тесты), **ruff**, **mypy**
* **Docker Compose v2**, **Makefile**, **pre-commit**
* **GitHub Actions** (линт+тесты+build)

---

## 3) Функциональные требования

### 3.1 Auth Service (`auth-svc`)

* Регистрация пользователя: email, password (bcrypt), имя.
* Логин: выдача **access** и **refresh** JWT (RS256), ротация refresh.
* Обновление токена: /auth/refresh.
* Профиль: /auth/me.
* Роли: `user`, `admin` (минимум — для примера).
* Аудит-логи входов (таблица логинов: user_id, ip, ua, time).

### 3.2 Task Service (`task-svc`)

* CRUD задач:

  * `title`, `description`, `status` (todo/in_progress/done/canceled),
  * `due_at` (дедлайн), `priority` (low/normal/high),
  * `tags` (многие-ко-многим),
  * `assignee_id` (ссылка на user из auth-svc — хранить как внешний UUID, без жёсткого FK).
* Фильтры и пагинация: по статусу, тегам, дедлайну, исполнителю.
* Массовые операции: смена статуса по списку id.
* Webhook-уведомления (опционально): при `status=done` отправлять POST в `notify-svc` или внешний URL.
* Rate limit на создание задач (через Nginx/Redis: например 60/мин на IP).

### 3.3 Notify Service (`notify-svc`)

* REST для постановки уведомлений: `/notify/email`, `/notify/webhook`.
* Celery-воркер: фоновые задачи (эмуляция отправки «письма», POST webhook).
* Планировщик напоминаний за N минут до `due_at` (периодическая Celery beat задача).
* DLQ (мёртвая очередь) логика: 3 ретрая с backoff → запись в таблицу `failed_notifications`.

---

## 4) Наблюдаемость и безопасность

* `/metrics` на каждом сервисе (FastAPI + Prometheus client).
* Трейс-ID в логах (OTel auto-instrumentation).
* Grafana дашборды: RPS, p50/p95/p99 latency, error rate 5xx/4xx, Celery success/failure.
* Loki: структурированные JSON-логи (uvicorn/gunicorn + app).
* JWT: RS256 ключи в volume, не коммитить. Секреты — через `.env.example` + описание Secret Manager.
* CORS: только `http://localhost` (дефолт).
* Nginx: rate limit + body size limit, proxy timeouts, gzip.

---

## 5) Контракты API (минимум)

### Auth

`POST /auth/register` → 201
`POST /auth/login` → 200 {access, refresh, expires_in}
`POST /auth/refresh` → 200 {access, refresh}
`GET /auth/me` (Authorization: Bearer) → 200 {id, email, name, role}

### Tasks

`POST /tasks` → 201 {id, ...}
`GET /tasks` (filters: status, tag, assignee_id, due_before/after, page/limit) → 200 [ ... ] + pagination
`GET /tasks/{id}` → 200
`PATCH /tasks/{id}` → 200
`DELETE /tasks/{id}` → 204
`POST /tasks/bulk-status` {ids:[], status} → 200

### Notify

`POST /notify/email` {to, subject, body} → 202
`POST /notify/webhook` {url, payload} → 202
`GET /notify/jobs/{id}` → 200 {status: queued|ok|failed, attempts, last_error?}

**Ответы ошибок:** единый формат:

```json
{"error": {"code": "VALIDATION_ERROR", "message": "..." }}
```

---

## 6) Данные и схемы

### 6.1 ERD (упрощённо)

```
auth.users(id PK uuid, email unique, password_hash, name, role, created_at)
auth.login_audit(id, user_id, ip, ua, created_at)

task.tasks(id PK uuid, title, description, status, priority, due_at, assignee_id(uuid), created_at, updated_at)
task.tags(id PK, name unique)
task.task_tags(task_id FK, tag_id FK)

notify.jobs(id PK uuid, type(email|webhook), status, payload jsonb, attempts, last_error, created_at)
```

### 6.2 Валидация (Pydantic v2)

* Модели запросов/ответов строго отделены от ORM-моделей.
* Конвертация типов (`datetime`, `UUID`), строгие `Annotated` валидации.

---

## 7) Инфраструктура (Docker Compose)

Сервисы:

* `nginx`, `auth-svc`, `task-svc`, `notify-svc`, `celery-worker`, `celery-beat`
* `auth-db`, `task-db` (Postgres x2), `redis`
* `prometheus`, `grafana`, `loki`, `promtail`, `otel-collector`

Сети: `public` (nginx) и `private` (сервисы + БД).
Тома: для БД, Grafana, Loki.

---

## 8) Makefile (минимум)

```
make up          # up -d
make down        # stop & rm
make logs        # tail -f
make migrate     # alembic upgrade head (все сервисы)
make lint        # ruff + mypy
make test        # pytest -q
make load        # locust/k6 (по желанию)
```

---

## 9) Структура репозитория

```
taskhub/
  docker-compose.yml
  gateway/
    nginx.conf
  auth-svc/
    app/
      api/routers/*.py
      core/config.py
      core/security.py
      models/*.py
      db/session.py
      db/migrations (alembic)
      services/jwt.py
      main.py
    tests/
    pyproject.toml
    alembic.ini
    Dockerfile
    .env.example
  task-svc/
    app/...
  notify-svc/
    app/...
    worker/ (celery)
  infra/
    prometheus/prometheus.yml
    grafana/provisioning/...
    loki/config.yml
    promtail/config.yml
    otel-collector/config.yaml
  .github/workflows/ci.yml
  Makefile
  README.md
```

---

## 10) Порядок выполнения (спринты)

### Спринт 0 — каркас

* Инициализация монорепо, базовый `docker-compose.yml`, сети/тома.
* Шаблоны трёх сервисов (FastAPI), `healthz`, `/metrics`.
* Nginx как API Gateway (роутинг `/auth`, `/tasks`, `/notify`).
* Pre-commit (ruff, mypy), Makefile, `.editorconfig`.

**Критерии приёмки:** `make up` поднимает 200 ОК на `GET /auth/healthz`, `GET /tasks/healthz`, `GET /notify/healthz`.

### Спринт 1 — Auth

* Модели, миграции Alembic.
* Регистрация, логин, refresh, me.
* JWT RS256, ротация refresh.
* pytest: юнит + интеграционные (`httpx.AsyncClient`).

**Критерии:** все тесты зелёные, 80%+ покрытие ядра.

### Спринт 2 — Tasks

* Модели/миграции, CRUD, фильтры/пагинация.
* Проверка JWT на всех эндпоинтах.
* Массовая смена статусов, события «done» → POST в notify-svc.
* Рейт-лимит в Nginx для POST /tasks.

**Критерии:** сценарий E2E (регистрация → логин → создать задачи → фильтр → done → событие в notify) работает.

### Спринт 3 — Notify + Celery

* Эндпоинты постановки уведомлений.
* Celery worker + Redis broker, ретраи с backoff.
* Periodic: напоминания за N минут до дедлайна.
* DLQ (failed_notifications).

**Критерии:** имитация отправки (логи), статус job отслеживается.

### Спринт 4 — Наблюдаемость

* Prometheus scrape, Grafana dashboard.
* Loki/Promtail — сбор JSON-логов.
* OTel трассировки (end-to-end через gateway).

**Критерии:** видны метрики RPS/latency/error rate; трейсы проходят меж сервисами.

### Спринт 5 — Безопасность и твёрдость

* Хард-настройки Nginx (timeouts, gzip, limits).
* Мини-пентест чеклист (OWASP API Top-10).
* Бэкапы БД (pg_dump) — скрипт/инструкции.
* Документация запуска и Troubleshooting.

**Критерии:** чеклист закрыт, дока полная.

### Спринт 6 — CI/CD (базовый)

* GitHub Actions: ruff/mypy/pytest, build docker.
* Артефакты: отчёты тестов.
* Тэгирование образов по `git sha`/`semver`.

**Критерии:** pipeline зелёный; PR-проверки блокируют merge при фейле.

---

## 11) Тест-кейсы (минимум)

* Регистрация/логин/refresh/доступ к /me без/с токеном.
* Создание 100 задач, фильтр по статусу/тегу/исполнителю.
* Массовая смена статуса → уведомление.
* Рейт-лимит (61-й POST за минуту → 429).
* Напоминание по дедлайну (проверка Celery job).
* Наблюдаемость: 10 RPS → метрики растут, latency в пределах.

---

## 12) Команды запуска (примеры)

```bash
# в корне проекта
cp auth-svc/.env.example auth-svc/.env
cp task-svc/.env.example task-svc/.env
cp notify-svc/.env.example notify-svc/.env
make up
make migrate   # прогон Alembic в обоих сервисах
make logs
```

Проверка:

```bash
# health
curl -s localhost/healthz
curl -s localhost/auth/healthz
curl -s localhost/tasks/healthz
curl -s localhost/notify/healthz

# регистрация+логин
curl -X POST localhost/auth/register -H 'Content-Type: application/json' \
  -d '{"email":"u@ex.com","password":"S3cret!","name":"Ibra"}'
```

---

## 13) Риски и ограничения

* Синхронизация пользователей между сервисами: храните только `assignee_id` как UUID, без жёсткого FK; проверку существования делайте через запрос к auth-svc (кэшировать в Redis).
* Расслоение схем БД → строгая миграционная дисциплина (Alembic автоген не панацея).
* Согласованность событий «task done» → делайте idempotency key на стороне notify-svc.
* Логи и метрики — шум: фильтруйте уровни, не логируйте PII.

---

## 14) Расширения (на будущее)

* API ключи для внешних интеграций; пер-сервисные scopes.
* Саги/Outbox (Debezium, Kafka/RabbitMQ).
* Трассировки БД (pg_stat_statements, APM).
* Rate limit per user (Redis token bucket).
* Файл-хранилище (S3-совместимое минио) для вложений к задачам.

---

Хочешь — начнём со **Спринта 0**: я дам стартовые файлы (`docker-compose.yml`, `nginx.conf`, каркасы `main.py` для сервисов, `.env.example`, `Makefile`). Ты просто скопируешь и запустишь.
